
    <% if 'DEBUG' == p('logstash.metadata_level') %>
        ruby {
            code => "
                n = Time.now
                event.set('@parser[duration]', (1000 * (n - Time.parse(event.get('@parser[timestamp]')))).to_i)
                event.set('@timer[ingested_to_parsed]', (1000 * (n - Time.parse(event.get('@ingestor[timestamp]')))).to_i) if event.get('@ingestor[timestamp]')
                timestamp = event.get('@timestamp')
                if timestamp.instance_of? Time
                    event.set('@timer[emit_to_ingested]', (1000 * (Time.parse(event.get('@ingestor[timestamp]')) - timestamp)).to_i) if event.get('@ingestor[timestamp]')
                    event.set('@timer[emit_to_parsed]', (1000 * (n - timestamp)).to_i)
                end
            "
        }
    <% end %>

    if ![@type] {
      mutate {
        add_field => [ "@type", "unknown" ]
      }
    }


    mutate {
      add_field => { "[@metadata][index_base]" => "<%=p('logstash_parser.elasticsearch.index_name.platform.base')%>" }
      add_field => { "[@metadata][index_period]" => "%{+<%=p('logstash_parser.elasticsearch.index_name.platform.period')%>}" } # YYYY.MM.dd
    }

    # Custom Override @metadata.index
    if [@index_type] == "app" {
        mutate {
            replace => { "[@metadata][index_base]" => "<%=p('logstash_parser.elasticsearch.index_name.app.base')%>" }
            replace => { "[@metadata][index_period]" => "%{+<%=p('logstash_parser.elasticsearch.index_name.app.period')%>}" } # YYYY.MM, xxxx.ww, YYYY.MM.dd
        }
        <% if p('logstash_parser.elasticsearch.index_name.app.append_org_to_base') %>
        if [@cf][org] {
            mutate {
                replace => { "[@metadata][index_base]" => "%{[@metadata][index_base]}-%{[@cf][org]}" }
            }
        }
        <% end %>
        <% if p('logstash_parser.elasticsearch.index_name.app.append_space_to_base') %>
        if [@cf][space] {
            mutate {
                replace => { "[@metadata][index_base]" => "%{[@metadata][index_base]}-%{[@cf][space]}" }
            }
        }
        <% end %>
        mutate {
            lowercase => [ "[@metadata][index_base]" ]
        }
    }
